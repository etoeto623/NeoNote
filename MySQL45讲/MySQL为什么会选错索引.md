本文主要介绍MySQL在执行sql时，优化器是怎么选择索引的，涉及到的知识点有：
- 优化器怎么统计数据
- 影响索引选择的因素有哪些
- 优化器选错索引时怎么办
# 0、实验环境
本文实验的准备数据如下
数据库表t
``` mysql
CREATE TABLE`t`(
	`id`int(11) NOT NULL,
	`a`int(11) DEFAULT NULL,
	`b`int(11) DEFAULT NULL,
	PRIMARY KEY(`id`),
	KEY `a` (`a`),
	KEY `b` (`b`)
)ENGINE=InnoDB;
```
数据使用存储过程初始化
``` mysql
delimiter;;
create procedure idata()
begin
	declare i int;
	set i=1;
	while(i<=100000) do
		insert into t values(i,i,i);
		set i=i+1;
	end while;
end;;
delimiter;
call idata();
```
# 1、优化器怎么统计数据
## 1、1、索引信息查看
使用`show index`命令可以查看索引的信息，如下：
``` shell
show index in t;
```
结果如下：
``` text
+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| t     |          0 | PRIMARY  |            1 | id          | A         |      100129 |     NULL | NULL   |      | BTREE      |         |               |
| t     |          1 | a        |            1 | a           | A         |      100129 |     NULL | NULL   | YES  | BTREE      |         |               |
| t     |          1 | b        |            1 | b           | A         |      100129 |     NULL | NULL   | YES  | BTREE      |         |               |
+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
```
其中，**Cardinality**表示索引的基数，即索引不同值的个数，数值越大表示索引的值越分散
在explain时，会提示索引扫描的行数，这个行数信息是一个大致的数据。
## 1、2、索引信息统计过程
MySQL通过**采样**的方式来统计索引的信息，具体的流程是：
- 抽取索引的N个内存页
- 统计索引页中的不同值，得到这些页面的平均不同值个数
- 将平均值乘以索引页数，得到这个索引的`基数`
## 1、3、统计信息更新
- 自动触发
统计信息也不是不变的，当变更的行数超过`1/M`时，会自动触发
- 手动更新
使用`analyze table t`命令可以手动触发

在MySQL中，有两种存储索引统计的方式，可以通过设置参数`innodb_stats_persistent`的值来选择：
- 设置为on的时候，表示统计信息会持久化存储。这时，默认的N是20，M是10。
- 设置为off的时候，表示统计信息只存储在内存中。这时，默认的N是8，M是16。
# 2、索引异常的处理
优化器会综合各方面因素来决定选择什么索引：
- 索引扫描行数
- 随机IO次数
- 是否设计排序
- ...
异常解决方法：
- 使用force index强制使用索引
- 使用analyze table t刷新统计信息
- 增加额外条件引导MySQL使用正确索引