这里来探讨下MySQL中进行数据更新时（insert或update），进行了哪些操作。

这里要讨论有索引场景下的更新。索引又分为**普通索引**和**唯一索引**

在MySQL中有个东西叫做***change buffer***
``` ad-note
change buffer的作用就是在内存中记录数据的更新信息，减少数据更新操作时的磁盘随机IO
```
change buffer的数据有如下几种场景会将数据落盘：
- 对相应的**数据页***进行读取时
- 后台任务定时刷数据

现在再来看一下有索引场景下的数据更新
- 唯一索引时：由于唯一索引更新时需要判断数据是否存在，因此需要将数据页加载到内存中，更新的话也可以直接更新内存页，change buffer也就没必要了
- 普通索引：会使用到change buffer
因此，两种索引在读数据时性能差异不大，但更新时，唯一索引需要有随机磁盘IO，推荐使用普通索引

# change buffer和redo log
在InnoDB中，数据更新还有一个redo log存在，这里结合change buffer和redolog看下数据更新的过程
![[changebuffer和redolog数据更新.excalidraw]]
如果数据页在内存中，redolog就记录操作内存页的信息，不在的话就记录change buffer的信息

带change buffer和redo log的数据读取过程如下：
![[changebuffer和redolog数据读取.excalidraw]]
如果数据在change buffer中，则先将数据merge到数据页


#changeBuffer